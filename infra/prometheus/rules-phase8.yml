groups:
  - name: divan-phase8-alerts
    rules:
      - alert: DivanHighErrorRate
        expr: rate(divan_http_requests_total{status=~"5.."}[5m]) / rate(divan_http_requests_total[5m]) > 0.05
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "HTTP 5xx error rate above 5%"
          description: |
            The proportion of 5xx responses has exceeded 5% over the last 10 minutes.
      - alert: DivanHighLatencyP95
        expr: histogram_quantile(0.95, sum by (le)(rate(divan_http_request_duration_seconds_bucket[5m]))) > 0.4
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "API latency p95 above 400ms"
          description: |
            The 95th percentile request latency is sustained above 400ms for 15 minutes.
      - alert: DivanRedisDown
        expr: divan_redis_up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Redis connectivity lost"
          description: "Redis ping has failed for 2 minutes."
      - alert: DivanPostgresDown
        expr: divan_postgres_up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Postgres connectivity lost"
          description: "Postgres readiness checks failing for 2 minutes."
      - alert: DivanSocketClientDrop
        expr: |
          (
            sum(max_over_time(divan_socketio_clients[5m])) - sum(min_over_time(divan_socketio_clients[5m]))
          ) / clamp_min(sum(max_over_time(divan_socketio_clients[5m])), 1) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Socket.IO client count dropped by more than 50%"
          description: |
            Aggregate Socket.IO client counts fell by over 50% within 5 minutes.
