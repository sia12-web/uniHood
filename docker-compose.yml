services:
  redis:
    image: redis:7.2-alpine
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    volumes:
      - ./infra/docker/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "127.0.0.1:6379:6379"
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 256M

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: unihood
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d unihood" ]
      interval: 5s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  backend:
    container_name: unihood-backend
    image: unihood/backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app
      - ./scripts:/work/scripts:ro
      - ./infra/migrations:/work/infra/migrations:ro
      - backend_uploads:/app/app/uploads
    environment:
      REDIS_URL: redis://redis:6379/0
      POSTGRES_URL: postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/unihood
      PYTHONPATH: /app
      ENVIRONMENT: ${ENVIRONMENT:-dev}
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-http://localhost:3000}
      COMMUNITIES_WORKERS_ENABLED: "true"
      # Make metrics endpoint public for Prometheus scraping
      OBS_METRICS_PUBLIC: "true"
      # Security: Required secrets (will fail if not set in .env)
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set in .env}
      SERVICE_SIGNING_KEY: ${SERVICE_SIGNING_KEY:?SERVICE_SIGNING_KEY must be set in .env}
      REFRESH_PEPPER: ${REFRESH_PEPPER:?REFRESH_PEPPER must be set in .env}
      # Cookie security
      COOKIE_SECURE: ${COOKIE_SECURE:-false}
      # Performance profiling (set via env vars for debug sessions)
      PERF_TRACE_LABELS: ${PERF_TRACE_LABELS:-false}
      PERF_DEBUG_MODE: ${PERF_DEBUG_MODE:-false}
      RUM_SAMPLE_RATE: ${RUM_SAMPLE_RATE:-0.10}
      TRACE_SAMPLE_RATE: ${TRACE_SAMPLE_RATE:-0.10}
    ports:
      - "8001:8000"
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      mailhog:
        condition: service_started
    command: >
      bash -c "echo 'Postgres is healthy, running migrations...' && python /work/scripts/apply_migrations.py && echo 'Migrations complete, starting app...' && uvicorn app.main:socket_app --host 0.0.0.0 --port 8000 --reload"
    # command: uvicorn app.debug:socket_app --host 0.0.0.0 --port 8000 --reload
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  activities:
    container_name: unihood-activities
    image: unihood/activities
    build:
      context: ./services/activities-core
      dockerfile: Dockerfile
      target: builder
    volumes:
      - ./services/activities-core:/app
      - /app/node_modules
    environment:
      POSTGRES_URL: postgresql://postgres:postgres@postgres:5432/unihood
      REDIS_URL: redis://redis:6379/0
      PORT: 3001
    ports:
      - "3011:3001"
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
    command: npm run dev

  mailhog:
    image: mailhog/mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 256M
  # Optional: Log monitoring service
  # Uncomment to enable real-time log monitoring and alerting
  # log-monitor:
  #   container_name: unihood-log-monitor
  #   build: ./tools/log-monitor
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #   environment:
  #     CONTAINER_PREFIX: unihood-
  #     CONSOLE_ONLY: "true"
  #     METRICS_ENABLED: "true"
  #     CPU_THRESHOLD: "80"
  #     MEMORY_THRESHOLD: "85"
  #     # SLACK_WEBHOOK: https://hooks.slack.com/services/...
  #   depends_on:
  #     - backend
  #     - activities
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.25'
  #         memory: 128M

volumes:
  pgdata:
  backend_uploads:
