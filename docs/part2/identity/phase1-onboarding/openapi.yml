openapi: 3.0.3
info: { title: Divan â€” Identity & Profiles (Phase 1), version: "1.0.0" }
paths:
  /auth/register:
    post:
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        "200": { description: "Registered (verification sent)" }
        "400": { description: "Validation error" }
        "409": { description: "Handle/email conflict" }
        "429": { description: "Rate limited" }
  /auth/verify-email:
    post:
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VerifyRequest' }
      responses:
        "200": { description: "Email verified" }
        "410": { description: "Token expired/used" }
  /auth/login:
    post:
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        "200": { description: "JWT tokens" }
        "401": { description: "Unauthorized" }
        "429": { description: "Rate limited" }
  /auth/resend:
    post:
      responses:
        "200": { description: "Verification resent" }
        "429": { description: "Rate limited" }
  /auth/campuses:
    get:
      responses:
        "200":
          description: "Campuses"
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Campus' }
  /profile/me:
    get:
      responses:
        "200":
          description: "My profile"
          content: { application/json: { schema: { $ref: '#/components/schemas/ProfileOut' } } }
    patch:
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProfilePatch' }
      responses:
        "200": { description: "Updated", content: { application/json: { schema: { $ref: '#/components/schemas/ProfileOut' } } } }
  /profile/avatar/presign:
    post:
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PresignRequest' }
      responses:
        "200": { description: "Presigned", content: { application/json: { schema: { $ref: '#/components/schemas/PresignResponse' } } } }
  /profile/avatar/commit:
    post:
      responses:
        "200": { description: "Avatar committed", content: { application/json: { schema: { $ref: '#/components/schemas/ProfileOut' } } } }

components:
  schemas:
    Campus:
      type: object
      required: [id, name, domain]
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        domain: { type: string }
    RegisterRequest:
      type: object
      required: [email, password, handle, campus_id]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        handle: { type: string }
        display_name: { type: string }
        campus_id: { type: string, format: uuid }
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }
    VerifyRequest:
      type: object
      required: [token]
      properties:
        token: { type: string }
    ProfileOut:
      type: object
      required: [id,email,email_verified,handle,display_name,bio,privacy,status]
      properties:
        id: { type: string, format: uuid }
        email: { type: string, format: email }
        email_verified: { type: boolean }
        handle: { type: string }
        display_name: { type: string }
        bio: { type: string }
        avatar_url: { type: string, nullable: true }
        campus_id: { type: string, format: uuid, nullable: true }
        privacy:
          type: object
          properties:
            visibility: { type: string, enum: [everyone,friends,none] }
            ghost_mode: { type: boolean }
        status:
          type: object
          properties:
            text: { type: string }
            emoji: { type: string }
            updated_at: { type: string, format: date-time }
    ProfilePatch:
      type: object
      properties:
        display_name: { type: string, maxLength: 80 }
        bio: { type: string, maxLength: 500 }
        handle: { type: string }
        privacy:
          type: object
          properties:
            visibility: { type: string, enum: [everyone,friends,none] }
            ghost_mode: { type: boolean }
        status:
          type: object
          properties:
            text: { type: string, maxLength: 120 }
            emoji: { type: string, maxLength: 4 }
    PresignRequest:
      type: object
      required: [mime, bytes]
      properties:
        mime: { type: string }
        bytes: { type: integer, minimum: 1 }
    PresignResponse:
      type: object
      required: [key,url,expires_s]
      properties:
        key: { type: string }
        url: { type: string }
        expires_s: { type: integer }
