============================= test session starts =============================
platform win32 -- Python 3.12.4, pytest-8.4.2, pluggy-1.5.0
rootdir: C:\Users\shahb\OneDrive\Desktop\Divan\backend
configfile: pyproject.toml
plugins: anyio-4.2.0, asyncio-1.0.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 5 items

tests\unit\test_activities_service.py .FF..                              [100%]

================================== FAILURES ===================================
__________________ test_story_builder_completes_after_turns ___________________

    @pytest.mark.asyncio
    async def test_story_builder_completes_after_turns():
    	service = ActivitiesService()
    	user_a = UserFactory("alice").to_user()
    	user_b = UserFactory("bob").to_user()
    
    	options = schemas.ActivityOptions(story=schemas.StoryOptions(turns=4, turn_seconds=15))
    	summary = await service.create_activity(user_a, user_b.id, schemas.CreateActivityRequest(kind="story_builder", options=options))
    	await service.start_activity(user_a, summary.id)
    
    	for turn in range(1, 5):
    		actor = user_a if turn % 2 == 1 else user_b
    		response = await service.submit_story(actor, schemas.StorySubmitRequest(activity_id=summary.id, content=f"Line {turn}"))
    		if turn < 4:
    			assert response["status"] == "continuing"
    		else:
    			assert response["status"] == "completed"
    
    	detail = await service.get_activity(user_a, summary.id)
    	assert detail.state == "completed"
    	story_meta = detail.meta.get("story", {})
>   	assert story_meta.get("next_turn") == 5
E    AssertionError: assert 4 == 5
E     +  where 4 = <built-in method get of dict object at 0x0000024CBF009E80>('next_turn')
E     +    where <built-in method get of dict object at 0x0000024CBF009E80> = {'lines': [{'content': 'Line 1', 'created_at': '2025-12-04T19:26:23.537558+00:00', 'idx': 1, 'user_id': 'alice'}, {'co...-12-04T19:26:23.542019+00:00', 'idx': 4, 'user_id': 'bob'}], 'max_chars': 400, 'next_turn': 4, 'next_user': 'bob', ...}.get

tests\unit\test_activities_service.py:92: AssertionError
_____________________ test_trivia_scoring_records_totals ______________________

    @pytest.mark.asyncio
    async def test_trivia_scoring_records_totals():
    	service = ActivitiesService()
    	user_a = UserFactory("alice").to_user()
    	user_b = UserFactory("bob").to_user()
    
    	options = schemas.ActivityOptions(trivia=schemas.TriviaOptions(questions=1, per_question_s=8))
    	summary = await service.create_activity(user_a, user_b.id, schemas.CreateActivityRequest(kind="trivia", options=options))
    	await service.reseed_trivia(user_a, summary.id, questions=1)
    	await service.start_activity(user_a, summary.id)
    
    	detail = await service.get_activity(user_a, summary.id)
    	round_info = detail.rounds[0]
    	correct_idx = int(round_info.meta.get("correct_idx", -1))
    
>   	await service.submit_trivia(
           ^^^^^^^^^^^^^^^^^^^^^
    		user_a,
    		schemas.TriviaAnswerRequest(activity_id=summary.id, round_idx=1, choice_idx=correct_idx),
    	)
E    AttributeError: 'ActivitiesService' object has no attribute 'submit_trivia'

tests\unit\test_activities_service.py:110: AttributeError
=========================== short test summary info ===========================
FAILED tests/unit/test_activities_service.py::test_story_builder_completes_after_turns
FAILED tests/unit/test_activities_service.py::test_trivia_scoring_records_totals
========================= 2 failed, 3 passed in 1.58s =========================
